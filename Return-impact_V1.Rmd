---
title: "Return-impact"
author: "Peimin Lin"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo =TRUE, 
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  fig.align = "center")
library(tidyverse) 
library(ggplot2)
library(ggExtra)
library(cluster)
library(NbClust)
library(Rmixmod)
library(mclust)
library(naniar)
```


```{r read_data}
positions <- readRDS("/monash-return-impact/data/position.rds")  
```


```{r overview}
summarydata <- summary(positions)

summarydata
```


```{r}
gg_miss_var(positions)
```


```{r}
serveone <- positions %>% 
  dplyr::filter(serve == 1)
```



```{r}
servetwo <- positions %>% 
  dplyr::filter(serve == 2)
```



# Marginal Distribution

```{r}
ggMarginal()
```
 



# Cluster Selection 

## serve one 
```{r}
clustone <-  Mclust(serveone, 3:12)
summary(clustone)
plot(clustone, what = 'BIC', 
     legendArgs = list(x = "bottomright", ncol = 5))
```

## serve two

```{r}
clusttwo <-  Mclust(servetwo, 3:12)
summary(clusttwo)
plot(clustone, what = 'BIC', 
     legendArgs = list(x = "bottomright", ncol = 5))
```



# GMM Rmixmod

# Cluster 9 


```{r}
modelo9 <- mixmodCluster(serveone[,c("X","Y")], 9)
modelo9
plot(modelo9)
```



```{r}
models9 <- mixmodCluster(servetwo[,c("X","Y")], 9)
models9
plot(models9)
```


# Player 

```{r}
playerone <- serveone %>%
  dplyr::filter(player %in% c("N. Djokovic", "R. Federer", "D. Thiem", "A. Zverev", "D. Schwartzman", "R. Nadal", "D. Medvedev", "S. Tsitsipas", "A. Rublev", "M. Berrettini", "R. Bautista Agut", "P. Carreno Busta") |
opponent %in% c("N. Djokovic", "R. Federer", "D. Thiem", "A. Zverev", "D. Schwartzman", "R. Nadal", "D. Medvedev", "S. Tsitsipas", "A. Rublev", "M. Berrettini", "R. Bautista Agut", "P. Carreno Busta") 
                  )
```




library(ggplot2)
library(tidyverse)
library(shiny)
library(dplyr)
library(plotly)
library(Rmixmod)

positions <- readRDS("data/position.rds")



# Define UI for application that draws a histogram
ui <- fluidPage(

    # Application title
    titlePanel("Cluster"),

    # Sidebar with a slider input for number of bins 
    sidebarLayout(
        sidebarPanel(
            selectInput('serve', 'Serve Number:', 
                        c(unique(as.character(positions$serve))),
                        selected = "1"),
            selectInput("player",
                        "Player:",
                        c(unique(as.character(positions$player))),
                        selected = c("N. Djokovic", "R. Federer", "D. Thiem", "A. Zverev", "D. Schwartzman", "R. Nadal", "D. Medvedev", "S. Tsitsipas", "A. Rublev", "M. Berrettini", "R. Bautista Agut", "P. Carreno Busta")),
            numericInput('clusters', 'Cluster count', 9, min = 3, max = 12))  
            
        ),

        # Show a plot of the generated distribution
        mainPanel(
           plotOutput("Plot")
        )
    )


# Define server logic required to draw a histogram
server <- function(input, output) {
    
    
        output$Plot <- renderPlot({
            selectdata <- positions %>% filter(serve == input$serve,
                                               player == input$player)  
   clusterplot <- mixmodCluster(selectdata[,c("X","Y")], input$clusters)
   plot(clusterplot)         
    
    })
}

# Run the application 
shinyApp(ui = ui, server = server)

```{r}
 courtcolor <- '#0a8d45'
   
    courtinside <- '#0a8d45'
   
```



```{r}
positions %>%
      filter(player %in% c("N. Djokovic", "R. Federer", "D. Thiem", "R. Nadal"),
             surface == "Hard",
             Servetype == "DeuceWide",
             serve == "1") %>%
      ggplot(aes(y = Y, x = X)) + 
      annotate("rect", xmin=-Inf, xmax=-5.4, ymin=-Inf, ymax=Inf, fill=courtcolor) +
      annotate("rect", xmin=-11.89, xmax=-5.4, ymin=-5.49, ymax=5.49, fill=courtinside) +
      geom_path(data = courtTrace, aes(x = x, y = y), color = 'black', size = 1) +
      geom_segment(aes(x= -5.4, xend= -5.4, y= -6.5, yend= 6.5), size = 2, color = 'lightgrey', 
                   lineend = 'round') +           
      geom_point(size = 3, aes(col = factor(serve, lab = "FIRST"), colour = player), alpha = 0.5) +
      scale_colour_manual("Serve", values = c("orange", "#f572b9")) +
      theme_bw() +
      coord_flip() + 
      theme(legend.position = "top") +
      scale_x_continuous("Depth (meters from net)", n. = 8) +
      scale_y_continuous("Lateral position (meters from center)", n. = 8)    
```














